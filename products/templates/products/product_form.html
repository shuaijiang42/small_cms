{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>{{ form.instance.pk|yesno:"Edit Product,Add Product" }}</h2>

    <form method="post" action="">
        {% csrf_token %}
        {{ form.as_p }}

        <h3>Nutritional Values</h3>
        <p class="text-muted small">
            At least one nutritional value is required. Please fill in at least one below.
        </p>

        {% if formset.non_form_errors %}
            <div class="alert alert-danger">
                {% for error in formset.non_form_errors %}
                    <p>{{ error }}</p>
                {% endfor %}
            </div>
        {% endif %}

        <div id="formset-container">
            {{ formset.management_form }}
            {% for form in formset %}
                <div class="formset-item card p-3 mb-2">
                    {% if form.errors %}
                        <div class="alert alert-danger">
                            {% for field_errors in form.errors.values %}
                                {% for error in field_errors %}
                                    <p>{{ error }}</p>
                                {% endfor %}
                            {% endfor %}
                        </div>
                    {% endif %}
                    <div class="row align-items-end">
                        <div class="col-md-5">
                            {{ form.nutritional_info.label_tag }} 
                            {{ form.nutritional_info }}
                        </div>
                        <div class="col-md-4">
                            {{ form.value.label_tag }} 
                            {{ form.value }}
                        </div>
                        <div class="col-md-3">
                            {{ form.DELETE }}
                            <button type="button" class="btn btn-danger btn-sm" onclick="confirmDelete(this)">
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>

        <button type="button" id="add-form" class="btn btn-outline-primary btn-sm mt-2">âž• Add another</button>
        <hr>
        <button type="submit" class="btn btn-success">Save</button>
        <a href="{% url 'product-list' %}" class="btn btn-secondary">Cancel</a>
    </form>
</div>


<style>
input[type="checkbox"][name$="-DELETE"] {
    display: none;
}
</style>

<script>
document.getElementById("add-form").addEventListener("click", function() {
    let formsetContainer = document.getElementById("formset-container");
    let totalForms = document.getElementById("id_nutritional_values-TOTAL_FORMS");
    let currentForms = parseInt(totalForms.value);

    let newFormHtml = formsetContainer.querySelector(".formset-item").outerHTML;
    newFormHtml = newFormHtml.replace(/-0-/g, `-${currentForms}-`);
    newFormHtml = newFormHtml.replace(/_0_/g, `_${currentForms}_`);

    let tempDiv = document.createElement("div");
    tempDiv.innerHTML = newFormHtml;
    let newForm = tempDiv.firstElementChild;

    newForm.querySelectorAll("input, select").forEach(el => {
        if (el.type !== "hidden" && el.type !== "checkbox") el.value = "";
        if (el.type === "checkbox") el.checked = false;
    });

    formsetContainer.appendChild(newForm);
    totalForms.value = currentForms + 1;
});

function confirmDelete(btn) {
    if (confirm("Are you sure you want to delete this nutritional value?")) {
        let formDiv = btn.closest(".formset-item");
        let deleteInput = formDiv.querySelector("input[type=checkbox][name$='-DELETE']");
        if (deleteInput) deleteInput.checked = true;
        formDiv.style.display = "none";
    }
}
</script>
{% endblock %}
