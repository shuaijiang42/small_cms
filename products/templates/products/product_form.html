{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>{{ form.instance.pk|yesno:"Edit Product,Add Product" }}</h2>

    <form method="post">
        {% csrf_token %}
        {{ form.as_p }}

        <h3>Nutritional Values of the product</h3>
        <div id="formset-container">
            {{ formset.management_form }}
            {% for form in formset %}
                <div class="formset-item card p-3 mb-2">
                    <div class="row align-items-end">
                        <div class="col-md-5">
                            {{ form.nutritional_info.label_tag }} 
                            {{ form.nutritional_info }}
                        </div>
                        <div class="col-md-4">
                            {{ form.value.label_tag }} 
                            {{ form.value }}
                            {% if form.instance.pk %}
                                <span class="badge bg-secondary">
                                    {{ form.instance.nutritional_info.unit }}
                                </span>
                            {% endif %}
                        </div>
                        <div class="col-md-3 d-flex gap-2">
                          <button type="submit" class="btn btn-success btn-sm">Save</button>
                          {% if form.instance.pk %}
                              <a href="{% url 'nutritionalvalue-delete' form.instance.pk %}" 
                                 class="btn btn-danger btn-sm">
                                  Delete
                              </a>
                          {% else %}
                              <button type="button" class="btn btn-danger btn-sm" disabled>
                                  Delete
                              </button>
                          {% endif %}
                      </div>
                    </div>
                </div>
            {% endfor %}
        
        </div>

        <button type="button" id="add-form" class="btn btn-outline-primary btn-sm mt-2">âž• Add another</button>
        <hr>
        <button type="submit" class="btn btn-success">Save</button>
        <a href="{% url 'product-list' %}" class="btn btn-secondary">Cancel</a>
    </form>
</div>

<script>
// Add new blank form dynamically
document.getElementById("add-form").addEventListener("click", function() {
    let formsetContainer = document.getElementById("formset-container");
    let totalForms = document.getElementById("id_nutritional_values-TOTAL_FORMS");
    let currentForms = formsetContainer.getElementsByClassName("formset-item").length;

    let newFormHtml = formsetContainer.querySelector(".formset-item").outerHTML;
    newFormHtml = newFormHtml.replace(/-\d+-/g, `-${currentForms}-`);
    newFormHtml = newFormHtml.replace(/_\d+_/g, `_${currentForms}_`);
    let tempDiv = document.createElement("div");
    tempDiv.innerHTML = newFormHtml;
    let newForm = tempDiv.firstElementChild;

    newForm.querySelectorAll("input, select").forEach(el => {
        if (el.type !== "hidden") el.value = "";
    });

    formsetContainer.appendChild(newForm);
    totalForms.value = currentForms + 1;
});


</script>
{% endblock %}
